var canvas=document.querySelector(".game-area__ctx"),ctx=canvas.getContext("2d"),panelWalls=document.querySelector(".game-panel-walls"),panelAreas=document.querySelector(".game-panel-areas"),panelWinds=document.querySelector(".game-panel-winds"),gridCheckbox=document.querySelector("input[id=toggleGrid]"),hideWallsCheckbox=document.querySelector("input[id=hideWalls]"),hideAreasCheckbox=document.querySelector("input[id=hideAreas]"),hideWindsCheckbox=document.querySelector("input[id=hideWinds]"),showAllElementsCheckbox=document.querySelector("input[id=showAllElements]"),selectedPanelItem=null,selectedPanelTab=null,selectedElements=null;let gameObj=JSON.parse('{"areas":[{"x":25,"y":32,"w":15,"h":15,"id":1,"color":"rgba(50,50,50,0.3)","params":{"coup":true,"x":true,"y":false},"active":false},{"x":30,"y":47,"w":5,"h":21,"id":3,"hide":false,"params":{"x":0,"y":true,"coup":false},"active":false},{"x":9,"y":68,"w":21,"h":11,"id":4,"hide":false,"params":{"x":0,"y":0,"coup":true},"active":false},{"x":79,"y":113,"w":11,"h":7,"id":5,"hide":false,"params":{"x":true,"y":false,"coup":false},"active":false},{"x":90,"y":113,"w":10,"h":7,"id":6,"hide":false,"params":{"x":0,"y":0,"coup":true},"active":false},{"x":91,"y":74,"w":9,"h":29,"id":7,"hide":false,"params":{"x":0,"y":true,"coup":false},"active":false},{"x":91,"y":33,"w":9,"h":20,"id":8,"hide":false,"params":{"x":0,"y":0,"coup":true},"active":false},{"x":91,"y":53,"w":9,"h":21,"id":9,"hide":false,"params":{"x":false,"y":true,"coup":true},"active":false},{"x":2,"y":22,"w":5,"h":5,"id":10,"color":"rgba(50,50,50,0.3)","params":{"coup":true,"x":true,"y":0},"hide":false}],"walls":[{"x":0,"y":79,"w":30,"h":1,"id":1,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":10,"y":31,"w":31,"h":1,"id":2,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":61,"y":103,"w":1,"h":10,"id":3,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":9,"y":8,"w":1,"h":24,"id":4,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":35,"y":47,"w":1,"h":21,"id":5,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":9,"y":39,"w":1,"h":28,"id":6,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":10,"y":39,"w":15,"h":1,"id":7,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":40,"y":32,"w":1,"h":15,"id":8,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":9,"y":67,"w":20,"h":1,"id":9,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":24,"y":40,"w":1,"h":7,"id":10,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":95,"y":112,"w":5,"h":1,"id":11,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":36,"y":47,"w":5,"h":1,"id":12,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":48,"y":67,"w":1,"h":15,"id":13,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":61,"y":95,"w":12,"h":1,"id":14,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":41,"y":90,"w":1,"h":14,"id":15,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":60,"y":82,"w":1,"h":14,"id":16,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":9,"y":112,"w":77,"h":1,"id":17,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":36,"y":67,"w":12,"h":1,"id":18,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":0,"y":104,"w":52,"h":1,"id":19,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":85,"y":103,"w":1,"h":9,"id":20,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":49,"y":81,"w":12,"h":1,"id":21,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":29,"y":80,"w":1,"h":10,"id":22,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":29,"y":90,"w":12,"h":1,"id":23,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":0,"y":79,"w":30,"h":1,"id":24,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":29,"y":47,"w":1,"h":21,"id":25,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":74,"y":90,"w":5,"h":1,"id":26,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":24,"y":47,"w":5,"h":1,"id":27,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":90,"y":40,"w":1,"h":63,"id":28,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["1","0","0","0"]},{"x":73,"y":90,"w":1,"h":15,"id":29,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]},{"x":85,"y":102,"w":5,"h":1,"id":30,"hide":false,"active":false,"bern":["0","0","0","0"],"thru":["0","0","0","0"]}]}');var winds=[{x:10,y:30,w:30,h:30,id:1,color:"rgba(0,255,255,0.3)",params:{X:1,Y:1,forse:1}}],areas=gameObj.areas,walls=gameObj.walls;const gridSettings={squareWidth:100,squareHeight:120},getSelectedElement=()=>selectedElements?selectedElements.find(e=>!0===e.active):null,getDraggableElement=()=>selectedElements?selectedElements.find(e=>!0===e.draggable):null,getSelectedWall=()=>walls.find(e=>!0===e.active),getSelectedArea=()=>areas.find(e=>!0===e.active),getSelectedWind=()=>winds.find(e=>!0===e.active),getAreaById=e=>areas.find(t=>t.id===e),getWallById=e=>walls.find(t=>t.id===e),getXPixelRatio=canvas.width/gridSettings.squareWidth,getYPixelRatio=canvas.height/gridSettings.squareHeight,xCoordsToPixels=e=>e*getXPixelRatio,yCoordsToPixels=e=>e*getYPixelRatio,canvasWidthInSquares=gridSettings.squareWidth,canvasHeightInSquares=gridSettings.squareHeight,generateElementId=()=>selectedElements.length+1||1,hideElement=(e,t)=>{e.classList.toggle("active");const a=selectedElements.find(e=>e.id===t);a.hide=!a.hide,renderAll()},copyElement=e=>{const t=selectedElements.filter(t=>t.id===e);let a;selectedElements===walls&&(a={...t[0],active:!1,draggable:!1,id:generateElementId()}),selectedElements!==winds&&selectedElements!==areas||(a={...t[0],params:{...t[0].params},active:!1,draggable:!1,id:generateElementId()}),selectedElements.push(a),renderAll()},deleteElement=e=>{const t=selectedElements.findIndex(t=>t.id===e);selectedElements.splice(t,1),document.querySelector(`#${selectedPanelTab}-${e}`).remove(),renderAll()},toggleAreaParams=(e,t)=>{t.classList.toggle("active");const a=getAreaById(e);a.params[t.id]=!a.params[t.id],renderAll()},setSelectedTab=e=>{if("settings"===e.id)return selectedElements=null,void(selectedPanelTab=null);"walls"===e.id?(selectedElements=walls,selectedPanelTab="wall"):"areas"===e.id?(selectedElements=areas,selectedPanelTab="area"):"wind"===e.id&&(selectedElements=winds,selectedPanelTab="wind")},updateWindPanel=e=>{if(!selectedElements)return;const t=document.querySelector(`#wind-${e.id}`);for(let a in e)t.querySelector(`input[name=${a}]`)&&(t.querySelector(`input[name=${a}]`).value=e[a])},updateAreaPanel=e=>{if(!selectedElements)return;const t=document.querySelector(`#area-${e.id}`);for(let a in e)t.querySelector(`input[name=${a}]`)&&(t.querySelector(`input[name=${a}]`).value=e[a])},updateWallPanel=e=>{if(!selectedElements)return;const t=document.querySelector(`#wall-${e.id}`);for(let a in e)t.querySelector(`input[name=${a}]`)&&(t.querySelector(`input[name=${a}]`).value=e[a])},setSelectedPanelItem=e=>{if(null===e)return selectedPanelItem.classList.remove("active"),void(selectedPanelItem=null);selectedPanelItem&&selectedPanelItem.classList.remove("active"),(selectedPanelItem=e).classList.add("active")},removeSelectedItem=()=>{const e=getSelectedWall(),t=getSelectedArea(),a=getSelectedWind();e&&(e.active=!1),t&&(t.active=!1),a&&(a.active=!1)},setSelectedElement=e=>{removeSelectedItem(),setSelectedPanelItem(e),selectedElements.forEach(t=>{e.id===`${selectedPanelTab}-${t.id}`?t.active=!0:t.active=!1}),renderAll()},addWallToPanel=e=>{document.querySelector(`#wall-${e.id}`)||panelWalls.insertAdjacentHTML("beforeend",`<div \n        class="game-panel-walls__item game-panel-item"\n        id="wall-${e.id}"\n        onmousedown="setSelectedElement(this)"\n    >\n        <div class="game-panel-item__coords">\n            <span>x:</span>\n            <input name="x" oninput="elementChange(this)" value="${e.x}">\n            <span>y:</span>\n            <input name="y" oninput="elementChange(this)" value="${e.y}">\n        </div>\n        <div class="game-panel-item__size">\n            <span>width:</span>\n            <input oninput="elementChange(this)" name="w" value="${e.w}">\n            <span>height:</span>\n            <input oninput="elementChange(this)" name="h" value="${e.h}">\n        </div>\n        <button class="game-panel-item__copy" onClick="copyElement(${e.id})">Copy</button>\n        <button class="game-panel-item__bern">\n            bern\n            <div class="game-panel-item__bern-settings">\n                <span id="bern" onClick="toggleWallSettings(this, ${e.id}, 0)">↑</span>\n                <div>\n                    <span id="bern" onClick="toggleWallSettings(this, ${e.id}, 1)">←</span>\n                    <span id="bern" onClick="toggleWallSettings(this, ${e.id}, 2)">→</span>\n                </div>\n                <span id="bern" onClick="toggleWallSettings(this, ${e.id}, 3)">↓</span>\n            </div>\n        </button>\n        <button class="game-panel-item__thru">\n            thru\n            <div class="game-panel-item__thru-settings">\n                <span id="thru" onClick="toggleWallSettings(this, ${e.id}, 0)">↑</span>\n                <div>\n                    <span id="thru" onClick="toggleWallSettings(this, ${e.id}, 1)">←</span>\n                    <span id="thru" onClick="toggleWallSettings(this, ${e.id}, 2)">→</span>\n                </div>\n                <span id="thru" onClick="toggleWallSettings(this, ${e.id}, 3)">↓</span>\n            </div>\n        </button>\n        <button class="game-panel-item__hide" onClick="hideElement(this, ${e.id})">\n            Toggle hide\n        </button>\n        <button class="game-panel-item__delete" onClick="deleteElement(${e.id})">\n            Delete\n        </button>\n    </div>`)},toggleWallSettings=(e,t,a)=>{e.classList.toggle("active");const n=getWallById(t);n[e.id][a]=!n[e.id][a]},addAreaToPanel=e=>{document.querySelector(`#area-${e.id}`)||panelAreas.insertAdjacentHTML("beforeend",`<div \n        class="game-panel-areas__item game-panel-item"\n        id="area-${e.id}"\n        onmousedown="setSelectedElement(this)"\n    >\n        <div class="game-panel-item__coords">\n            <span>x:</span>\n            <input name="x" oninput="elementChange(this)" value="${e.x}">\n            <span>y:</span>\n            <input name="y" oninput="elementChange(this)" value="${e.y}">\n        </div>\n        <div class="game-panel-item__size">\n            <span>width:</span>\n            <input oninput="elementChange(this)" name="w" value="${e.w}">\n            <span>height:</span>\n            <input oninput="elementChange(this)" name="h" value="${e.h}">\n        </div>\n        <div class="game-panel-item__params">\n            <button id="x" class="${e.params.x?"active":""}" onClick="toggleAreaParams(${e.id}, this)">\n                X\n            </button>\n            <button id="y" class="${e.params.y?"active":""}" onClick="toggleAreaParams(${e.id}, this)">\n                Y\n            </button>\n            <button class="${e.params.y?"active":""}"\n                onClick="coupArea(this, ${e.id})\n             ">\n                Coup\n            </button>\n        </div>\n        <button class="game-panel-item__copy" onClick="copyElement(${e.id})">Copy</button>\n        <button class="game-panel-item__hide" onClick="hideElement(this, ${e.id})">\n            Toggle hide\n        </button>\n        <button class="game-panel-item__delete" onClick="deleteElement(${e.id})">\n            Delete\n        </button>\n    </div>`)},addWindToPanel=e=>{document.querySelector(`#wind-${e.id}`)||panelWinds.insertAdjacentHTML("beforeend",`<div \n        class="game-panel-wind__item game-panel-item"\n        id="wind-${e.id}"\n        onmousedown="setSelectedElement(this)"\n    >\n        <div class="game-panel-item__coords">\n            <span>x:</span>\n            <input name="x" oninput="elementChange(this)" value="${e.x}">\n            <span>y:</span>\n            <input name="y" oninput="elementChange(this)" value="${e.y}">\n        </div>\n        <div class="game-panel-item__size">\n            <span>width:</span>\n            <input oninput="elementChange(this)" name="w" value="${e.w}">\n            <span>height:</span>\n            <input oninput="elementChange(this)" name="h" value="${e.h}">\n        </div>\n        <div class="game-panel-item__params">\n            <span>X:</span>\n            <input oninput="elementChange(this)" name="X" value="${e.params.X}">\n            <span>Y:</span>\n            <input oninput="elementChange(this)" name="Y" value="${e.params.Y}">\n            <span>Forse:</span>\n            <input oninput="elementChange(this)" name="forse" value="${e.params.forse}">\n        </div>\n        <button class="game-panel-item__copy" onClick="copyElement(${e.id})">Copy</button>\n        <button class="game-panel-item__hide" onClick="hideElement(this, ${e.id})">\n            Toggle hide\n        </button>\n        <button class="game-panel-item__delete" onClick="deleteElement(${e.id})">\n            Delete\n        </button>\n    </div>`)},coupArea=(e,t)=>{e.classList.toggle("active");const a=getAreaById(t);a.params.coup=!a.params.coup,renderAll()},changeAreaColor=e=>{let t=220,a=220,n=220;!e.params.x||(t-=120),!e.params.y||(n-=120),!e.params.coup||(a-=150),e.color=`rgba(${t},${a},${n}, 0.3)`},renderGrid=e=>{ctx.beginPath();const t=canvas.width-2,a=canvas.height-2,n=t/gridSettings.squareWidth,l=a/gridSettings.squareHeight;ctx.strokeStyle="#bdbdbd",ctx.lineWidth=.1;for(var s=n;s<t;s+=n)ctx.strokeRect(s,0,.1,a);for(var i=l;i<a;i+=l)ctx.strokeRect(0,i,t,.1);ctx.fill(),ctx.closePath()},drawElement=e=>{!showAllElementsCheckbox.checked&&e.hide||(ctx.beginPath(),ctx.rect(xCoordsToPixels(e.x),yCoordsToPixels(e.y),xCoordsToPixels(e.w),yCoordsToPixels(e.h)),e.active&&(ctx.strokeStyle="red",ctx.lineWidth=3,ctx.stroke()),ctx.fillStyle=e.color||"black",ctx.fill(),ctx.closePath())},renderAll=()=>{ctx.clearRect(0,0,canvas.width,canvas.height),gridCheckbox.checked&&renderGrid(),showAllElementsCheckbox.checked,hideAreasCheckbox.checked||areas.forEach(e=>{changeAreaColor(e),addAreaToPanel(e),updateAreaPanel(e),drawElement(e)}),hideWindsCheckbox.checked||winds.forEach(e=>{addWindToPanel(e),updateWindPanel(e),drawElement(e)}),hideWallsCheckbox.checked||walls.forEach(e=>{addWallToPanel(e),updateWallPanel(e),drawElement(e)})};renderAll();const elementChange=e=>{getSelectedElement()[e.name]=+e.value,renderAll()},addWall=()=>{const e={x:canvasHeightInSquares/2,y:canvasWidthInSquares/2,w:15,h:15,id:generateElementId()};selectedElements.push(e),renderAll()},addArea=()=>{const e={x:canvasHeightInSquares/2,y:canvasWidthInSquares/2,w:15,h:15,id:generateElementId(),params:{}};selectedElements.push(e),renderAll()},addWind=()=>{const e={x:canvasHeightInSquares/2,y:canvasWidthInSquares/2,w:15,h:15,id:generateElementId(),params:{X:0,Y:0,forse:0},color:"rgba(0,255,255,0.3)"};selectedElements.push(e),renderAll()},takeDraggableElement=e=>{xStartFoDrug=e.clientX-canvas.offsetTop,yStartFoDrug=e.clientY-canvas.offsetLeft,removeSelectedItem();const t=selectedElements;if(t){for(let e=0;e<t.length;e++){if(t[e].hide)continue;const a=xCoordsToPixels(t[e].x),n=a+xCoordsToPixels(t[e].w),l=xCoordsToPixels(t[e].y),s=l+xCoordsToPixels(t[e].h);if(xStartFoDrug>a&&xStartFoDrug<n&&yStartFoDrug>l&&yStartFoDrug<s){t[e].active=!0,setSelectedPanelItem(document.querySelector(`#${selectedPanelTab}-${t[e].id}`)),t[e].draggable=!0,t[e].xStatr=t[e].x,t[e].yStatr=t[e].y;break}}!getSelectedElement()&&selectedPanelItem&&setSelectedPanelItem(null),renderAll()}};function xPixelsToCoords(e){return Math.round(e/getXPixelRatio)}function yPixelsToCoords(e){return Math.round(e/getYPixelRatio)}const dragElement=e=>{const t=e.clientX-canvas.offsetTop,a=e.clientY-canvas.offsetLeft,n=getDraggableElement();if(n){let e=xPixelsToCoords(t-xStartFoDrug),l=xPixelsToCoords(a-yStartFoDrug);const s=canvasWidthInSquares-n.w,i=canvasHeightInSquares-n.h,d=0,r=0;n.x=Math.min(n.xStatr+e,s),n.y=Math.min(n.yStatr+l,i),n.x=Math.max(n.x,d),n.y=Math.max(n.y,r),renderAll()}},dragElementOnKey=e=>{let t=getSelectedElement();if(t){let a=t.w>t.h?"w":"h";switch(e.code){case"KeyD":case"ArrowRight":t.x+t.w<canvasWidthInSquares?t.x+=1:t.x=canvasWidthInSquares-t.w;break;case"KeyA":case"ArrowLeft":0<t.x&&(t.x-=1);break;case"KeyS":case"ArrowDown":t.y+1+t.h<canvasHeightInSquares?t.y+=1:t.y=canvasHeightInSquares-t.h;break;case"KeyW":case"ArrowUp":0<t.y&&(t.y-=1);break;case"KeyQ":t[a]>10&&(t[a]-=1);break;case"KeyE":t[a]+=1}}renderAll()},dropDraggableElement=e=>{const t=getDraggableElement();t&&(t.draggable=null,delete t.xStatr,delete t.yStatr)};canvas.addEventListener("mousedown",takeDraggableElement),canvas.addEventListener("mousemove",dragElement),document.addEventListener("keydown",dragElementOnKey),document.addEventListener("mouseup",dropDraggableElement);